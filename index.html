<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨˜äº‹ã‚«ãƒ‹ãƒãƒªæ¤œçŸ¥ãƒ„ãƒ¼ãƒ«</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #E9E9E9;
            min-height: 100vh;
            padding: 40px 20px;
            color: #000;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #000;
            text-align: left;
            margin-bottom: 40px;
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -0.03em;
            text-transform: uppercase;
        }

        .card {
            background: #fff;
            border: 3px solid #000;
            padding: 32px;
            margin-bottom: 24px;
        }

        .card h2 {
            color: #000;
            margin-bottom: 24px;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border-bottom: 3px solid #000;
            padding-bottom: 12px;
        }

        .input-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .input-method {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .input-method button {
            padding: 12px 24px;
            border: 2px solid #000;
            background: #fff;
            color: #000;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.15s ease;
        }

        .input-method button.active {
            background: #000;
            color: #fff;
        }

        .input-method button:hover {
            background: #000;
            color: #fff;
        }

        textarea {
            width: 100%;
            height: 200px;
            padding: 16px;
            border: 2px solid #000;
            font-size: 14px;
            resize: vertical;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            background: #fff;
        }

        textarea:focus {
            outline: none;
            box-shadow: 4px 4px 0 #000;
        }

        .file-input-wrapper {
            border: 2px dashed #000;
            padding: 48px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s ease;
            background: #fff;
        }

        .file-input-wrapper:hover {
            background: #f5f5f5;
            box-shadow: 4px 4px 0 #000;
        }

        .file-input-wrapper input {
            display: none;
        }

        .btn-primary {
            background: #000;
            color: #fff;
            border: none;
            padding: 16px 40px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: all 0.15s ease;
        }

        .btn-primary:hover {
            box-shadow: 4px 4px 0 #333;
            transform: translate(-2px, -2px);
        }

        .btn-primary:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-section {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #ddd;
            margin: 16px 0;
        }

        .progress-fill {
            height: 100%;
            background: #000;
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            color: #666;
            font-size: 13px;
            font-weight: 500;
        }

        .results-section {
            display: none;
        }

        .threshold-control {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding: 16px;
            background: #f5f5f5;
            border: 2px solid #000;
        }

        .threshold-control label {
            font-weight: 700;
            color: #000;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .cannibalization-item {
            border: 2px solid #000;
            padding: 24px;
            margin-bottom: 16px;
            background: #fff;
            transition: all 0.15s ease;
        }

        .cannibalization-item:hover {
            box-shadow: 4px 4px 0 #000;
            transform: translate(-2px, -2px);
        }

        .cannibalization-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #000;
        }

        .cannibalization-header span:first-child {
            font-weight: 800;
            font-size: 1.1rem;
        }

        .similarity-badge {
            padding: 6px 16px;
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .similarity-high {
            background: #000;
            color: #fff;
        }

        .similarity-medium {
            background: #333;
            color: #fff;
        }

        .similarity-low {
            background: #E9E9E9;
            color: #000;
            border: 1px solid #000;
        }

        .solution-box {
            margin-top: 16px;
            padding: 16px;
            background: #f5f5f5;
            border-left: 4px solid #000;
        }

        .solution-box h4 {
            color: #000;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
        }

        .solution-box ul {
            margin: 0;
            padding-left: 20px;
            font-size: 13px;
            color: #333;
        }

        .solution-box li {
            margin-bottom: 6px;
        }

        .article-pair {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .article-box {
            background: #f5f5f5;
            padding: 16px;
            border: 1px solid #ccc;
        }

        .article-box h4 {
            font-size: 0.7rem;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
        }

        .article-box a {
            color: #000;
            text-decoration: none;
            font-weight: 600;
            word-break: break-all;
        }

        .article-box a:hover {
            text-decoration: underline;
        }

        .headings-list {
            margin-top: 12px;
            font-size: 12px;
            color: #444;
        }

        .headings-list li {
            margin-left: 16px;
            margin-bottom: 4px;
        }

        .matching-headings {
            margin-top: 16px;
            padding: 16px;
            background: #f9f9f9;
            border: 1px solid #ddd;
        }

        .matching-headings h4 {
            color: #000;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
        }

        .matching-headings ul {
            list-style: none;
        }

        .matching-headings li {
            padding: 6px 0;
            font-size: 12px;
            color: #444;
            border-bottom: 1px solid #eee;
        }

        .matching-headings li:last-child {
            border-bottom: none;
        }

        .no-results {
            text-align: center;
            padding: 48px;
            color: #666;
            font-weight: 500;
        }

        .headings-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .headings-table th,
        .headings-table td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .headings-table th {
            background: #000;
            color: #fff;
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .headings-table tr:hover {
            background: #f5f5f5;
        }

        .tab-buttons {
            display: flex;
            gap: 0;
            margin-bottom: 24px;
        }

        .tab-btn {
            padding: 12px 24px;
            border: 2px solid #000;
            border-right: none;
            background: #fff;
            color: #000;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.15s ease;
        }

        .tab-btn:last-of-type {
            border-right: 2px solid #000;
        }

        .tab-btn.active {
            background: #000;
            color: #fff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .export-btn {
            background: #000;
            color: #fff;
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-left: 8px;
            transition: all 0.15s ease;
        }

        .export-btn:hover {
            box-shadow: 3px 3px 0 #333;
            transform: translate(-1px, -1px);
        }

        .error-message {
            background: #fff;
            border: 2px solid #000;
            border-left: 6px solid #000;
            color: #000;
            padding: 16px;
            margin-bottom: 16px;
            font-weight: 500;
        }

        .hidden {
            display: none !important;
        }

        .note {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 16px;
            margin-top: 16px;
            font-size: 13px;
            color: #666;
        }

        .note strong {
            color: #000;
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .article-pair {
                grid-template-columns: 1fr;
            }

            .input-method {
                flex-direction: column;
            }

            h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>è¨˜äº‹ã‚«ãƒ‹ãƒãƒªæ¤œçŸ¥ãƒ„ãƒ¼ãƒ«</h1>

        <div class="card">
            <h2>1. URLã‚’å…¥åŠ›</h2>
            <div class="input-section">
                <div class="input-method">
                    <button id="btn-text" class="active" onclick="switchInputMethod('text')">ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›</button>
                    <button id="btn-csv" onclick="switchInputMethod('csv')">CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                </div>

                <div id="text-input">
                    <textarea id="url-input" placeholder="URLã‚’1è¡Œã«1ã¤ãšã¤å…¥åŠ›ã—ã¦ãã ã•ã„&#10;&#10;ä¾‹:&#10;https://example.com/article1&#10;https://example.com/article2&#10;https://example.com/article3"></textarea>
                </div>

                <div id="csv-input" class="hidden">
                    <div class="file-input-wrapper" onclick="document.getElementById('csv-file').click()">
                        <input type="file" id="csv-file" accept=".csv,.txt" onchange="handleFileUpload(event)">
                        <p>ã‚¯ãƒªãƒƒã‚¯ã—ã¦CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ<br><small>ï¼ˆ.csv ã¾ãŸã¯ .txtï¼‰</small></p>
                    </div>
                    <p id="file-name" style="margin-top: 8px; color: #666;"></p>
                </div>

                <div class="note">
                    <strong>æ³¨æ„:</strong> CORSã®åˆ¶é™ã«ã‚ˆã‚Šã€ã“ã®ãƒ„ãƒ¼ãƒ«ã¯CORSãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨ã—ã¦è¦‹å‡ºã—ã‚’å–å¾—ã—ã¾ã™ã€‚ä¸€éƒ¨ã®ã‚µã‚¤ãƒˆã§ã¯å–å¾—ã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ãã®å ´åˆã¯ã€è¦‹å‡ºã—ã‚’æ‰‹å‹•ã§å…¥åŠ›ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
                </div>

                <button class="btn-primary" id="analyze-btn" onclick="startAnalysis()">
                    è¦‹å‡ºã—ã‚’åé›†ã—ã¦åˆ†æ
                </button>
            </div>
        </div>

        <div class="card progress-section" id="progress-section">
            <h2>å‡¦ç†ä¸­...</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p class="progress-text" id="progress-text">0 / 0 ãƒšãƒ¼ã‚¸ã‚’å‡¦ç†ä¸­</p>
        </div>

        <div class="card results-section" id="results-section">
            <h2>åˆ†æçµæœ</h2>

            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('cannibalization')">ã‚«ãƒ‹ãƒãƒªæ¤œå‡º</button>
                <button class="tab-btn" onclick="switchTab('headings')">è¦‹å‡ºã—ä¸€è¦§</button>
                <button class="export-btn" onclick="exportResults()">ã‚«ãƒ‹ãƒãƒªCSV</button>
                <button class="export-btn" onclick="exportHeadingsList()">è¦‹å‡ºã—CSV</button>
            </div>

            <div id="cannibalization-tab" class="tab-content active">
                <div class="threshold-control">
                    <label>è¡¨ç¤ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</label>
                    <select id="filter-level" onchange="displayCannibalizations()" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                        <option value="40">â—â—‹ è¦å¯¾ç­–ãƒ»è¦ç¢ºèªã®ã¿</option>
                        <option value="20">â—â—‹â–³ ã™ã¹ã¦è¡¨ç¤º</option>
                        <option value="60">â— è¦å¯¾ç­–ã®ã¿</option>
                    </select>
                </div>
                <div id="cannibalization-results"></div>
            </div>

            <div id="headings-tab" class="tab-content">
                <div id="headings-list"></div>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let articlesData = [];
        let cannibalizations = [];

        // å…¥åŠ›æ–¹æ³•ã®åˆ‡ã‚Šæ›¿ãˆ
        function switchInputMethod(method) {
            document.getElementById('btn-text').classList.toggle('active', method === 'text');
            document.getElementById('btn-csv').classList.toggle('active', method === 'csv');
            document.getElementById('text-input').classList.toggle('hidden', method !== 'text');
            document.getElementById('csv-input').classList.toggle('hidden', method !== 'csv');
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('file-name').textContent = `é¸æŠ: ${file.name}`;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                // CSVã®å ´åˆã¯æœ€åˆã®åˆ—ã‚’URLã¨ã—ã¦æ‰±ã†
                const lines = content.split('\n');
                const urls = lines.map(line => {
                    const parts = line.split(',');
                    return parts[0].trim().replace(/"/g, '');
                }).filter(url => url && url.startsWith('http'));

                document.getElementById('url-input').value = urls.join('\n');
                switchInputMethod('text');
            };
            reader.readAsText(file);
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
        }

        // ã—ãã„å€¤æ›´æ–°
        function updateThreshold() {
            const value = document.getElementById('threshold').value;
            document.getElementById('threshold-value').textContent = `${value}%`;
            displayCannibalizations();
        }

        // åˆ†æé–‹å§‹
        async function startAnalysis() {
            const urlInput = document.getElementById('url-input').value.trim();
            const urls = urlInput.split('\n').map(u => u.trim()).filter(u => u && u.startsWith('http'));

            if (urls.length < 2) {
                alert('å°‘ãªãã¨ã‚‚2ã¤ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // UIæ›´æ–°
            document.getElementById('analyze-btn').disabled = true;
            document.getElementById('progress-section').style.display = 'block';
            document.getElementById('results-section').style.display = 'none';

            articlesData = [];

            // å„URLã‹ã‚‰è¦‹å‡ºã—ã‚’å–å¾—
            for (let i = 0; i < urls.length; i++) {
                updateProgress(i, urls.length);

                try {
                    const headings = await fetchHeadings(urls[i]);
                    articlesData.push({
                        url: urls[i],
                        title: headings.title || urls[i],
                        headings: headings.headings
                    });
                } catch (error) {
                    console.error(`Error fetching ${urls[i]}:`, error);
                    articlesData.push({
                        url: urls[i],
                        title: urls[i],
                        headings: [],
                        error: error.message
                    });
                }

                // ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–
                await sleep(500);
            }

            updateProgress(urls.length, urls.length);

            // ã‚«ãƒ‹ãƒãƒªåˆ†æ
            analyzeCannibalizations();

            // çµæœè¡¨ç¤º
            displayResults();

            document.getElementById('analyze-btn').disabled = false;
            document.getElementById('progress-section').style.display = 'none';
            document.getElementById('results-section').style.display = 'block';
        }

        // é€²æ—æ›´æ–°
        function updateProgress(current, total) {
            const percent = (current / total) * 100;
            document.getElementById('progress-fill').style.width = `${percent}%`;
            document.getElementById('progress-text').textContent = `${current} / ${total} ãƒšãƒ¼ã‚¸ã‚’å‡¦ç†ä¸­`;
        }

        // è¦‹å‡ºã—å–å¾—
        async function fetchHeadings(url) {
            // CORSãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;

            try {
                const response = await fetch(proxyUrl);
                const data = await response.json();

                if (!data.contents) {
                    throw new Error('ãƒšãƒ¼ã‚¸ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }

                const parser = new DOMParser();
                const doc = parser.parseFromString(data.contents, 'text/html');

                // ã‚¿ã‚¤ãƒˆãƒ«å–å¾—
                const title = doc.querySelector('title')?.textContent ||
                             doc.querySelector('h1')?.textContent ||
                             url;

                // è¦‹å‡ºã—å–å¾— (H1, H2, H3) - å…±é€šãƒŠãƒ“è¦ç´ ã‚’é™¤å¤–
                const headings = [];
                const excludePatterns = [
                    /ã‚«ãƒ†ã‚´ãƒªãƒ¼\s*ä¸€è¦§/i,
                    /æ–°ç€è¨˜äº‹/i,
                    /äººæ°—è¨˜äº‹/i,
                    /ãƒ©ãƒ³ã‚­ãƒ³ã‚°/i,
                    /é–¢é€£è¨˜äº‹/i,
                    /ãŠã™ã™ã‚è¨˜äº‹/i,
                    /æœ€æ–°è¨˜äº‹/i,
                    /ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–/i,
                    /ã‚¿ã‚°ä¸€è¦§/i,
                    /ã‚µã‚¤ãƒ‰ãƒãƒ¼/i,
                    /ãƒ•ãƒƒã‚¿ãƒ¼/i,
                    /ãƒ¡ãƒ‹ãƒ¥ãƒ¼/i
                ];
                doc.querySelectorAll('h1, h2, h3').forEach(h => {
                    const text = h.textContent.trim();
                    if (text && text.length > 0) {
                        // é™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ä¸€è‡´ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        const shouldExclude = excludePatterns.some(pattern => pattern.test(text));
                        if (!shouldExclude) {
                            headings.push({
                                level: h.tagName.toLowerCase(),
                                text: text
                            });
                        }
                    }
                });

                return { title, headings };
            } catch (error) {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: åˆ¥ã®ãƒ—ãƒ­ã‚­ã‚·ã‚’è©¦ã™
                try {
                    const fallbackUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
                    const response = await fetch(fallbackUrl);
                    const html = await response.text();

                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    const title = doc.querySelector('title')?.textContent ||
                                 doc.querySelector('h1')?.textContent ||
                                 url;

                    // è¦‹å‡ºã—å–å¾— (H2, H3) - å…±é€šãƒŠãƒ“è¦ç´ ã‚’é™¤å¤–
                    const headings = [];
                    const excludePatterns = [
                        /ã‚«ãƒ†ã‚´ãƒªãƒ¼\s*ä¸€è¦§/i,
                        /æ–°ç€è¨˜äº‹/i,
                        /äººæ°—è¨˜äº‹/i,
                        /ãƒ©ãƒ³ã‚­ãƒ³ã‚°/i,
                        /é–¢é€£è¨˜äº‹/i,
                        /ãŠã™ã™ã‚è¨˜äº‹/i,
                        /æœ€æ–°è¨˜äº‹/i,
                        /ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–/i,
                        /ã‚¿ã‚°ä¸€è¦§/i,
                        /ã‚µã‚¤ãƒ‰ãƒãƒ¼/i,
                        /ãƒ•ãƒƒã‚¿ãƒ¼/i,
                        /ãƒ¡ãƒ‹ãƒ¥ãƒ¼/i
                    ];
                    doc.querySelectorAll('h1, h2, h3').forEach(h => {
                        const text = h.textContent.trim();
                        if (text && text.length > 0) {
                            const shouldExclude = excludePatterns.some(pattern => pattern.test(text));
                            if (!shouldExclude) {
                                headings.push({
                                    level: h.tagName.toLowerCase(),
                                    text: text
                                });
                            }
                        }
                    });

                    return { title, headings };
                } catch (e) {
                    throw new Error('å–å¾—å¤±æ•—');
                }
            }
        }

        // ã‚¹ãƒªãƒ¼ãƒ—é–¢æ•°
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ã‚«ãƒ‹ãƒãƒªåˆ†æ
        function analyzeCannibalizations() {
            cannibalizations = [];

            for (let i = 0; i < articlesData.length; i++) {
                for (let j = i + 1; j < articlesData.length; j++) {
                    const article1 = articlesData[i];
                    const article2 = articlesData[j];

                    if (article1.headings.length === 0 || article2.headings.length === 0) {
                        continue;
                    }

                    const similarity = calculateSimilarity(article1.headings, article2.headings);
                    const matchingHeadings = findMatchingHeadings(article1.headings, article2.headings);

                    cannibalizations.push({
                        article1,
                        article2,
                        similarity,
                        matchingHeadings
                    });
                }
            }

            // é¡ä¼¼åº¦ã§ã‚½ãƒ¼ãƒˆ
            cannibalizations.sort((a, b) => b.similarity - a.similarity);
        }

        // é¡ä¼¼åº¦è¨ˆç®— (è¤‡åˆã‚¹ã‚³ã‚¢: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´ + N-gramé¡ä¼¼åº¦)
        function calculateSimilarity(headings1, headings2) {
            const texts1 = headings1.map(h => normalizeText(h.text));
            const texts2 = headings2.map(h => normalizeText(h.text));

            // å…¨è¦‹å‡ºã—ã‚’çµåˆ
            const allText1 = texts1.join(' ');
            const allText2 = texts2.join(' ');

            // 1. é‡è¦ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ä¸€è‡´ç‡ï¼ˆæ—¥æœ¬èªå¯¾å¿œï¼‰
            const keywords1 = extractKeywords(allText1);
            const keywords2 = extractKeywords(allText2);

            let keywordMatches = 0;
            for (const kw of keywords1) {
                if (keywords2.has(kw)) keywordMatches++;
            }
            const keywordSim = keywords1.size > 0
                ? keywordMatches / Math.max(keywords1.size, keywords2.size)
                : 0;

            // 2. è¦‹å‡ºã—åŒå£«ã®ãƒ™ã‚¹ãƒˆãƒãƒƒãƒã‚’æ¢ã™
            let bestMatches = [];
            for (const t1 of texts1) {
                let bestSim = 0;
                for (const t2 of texts2) {
                    const sim = textSimilarity(t1, t2);
                    if (sim > bestSim) bestSim = sim;
                }
                if (bestSim > 0.15) {
                    bestMatches.push(bestSim);
                }
            }

            const matchRatio = bestMatches.length > 0
                ? bestMatches.reduce((a, b) => a + b, 0) / Math.min(texts1.length, texts2.length)
                : 0;

            // 3. N-gramå…¨ä½“é¡ä¼¼åº¦
            const overallNgramSim = textSimilarity(allText1, allText2);

            // æœ€çµ‚ã‚¹ã‚³ã‚¢: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´ã‚’é‡è¦–
            const finalScore = (keywordSim * 0.5 + matchRatio * 0.3 + overallNgramSim * 0.2) * 100;

            return Math.round(finalScore);
        }

        // ãƒ†ã‚­ã‚¹ãƒˆæ­£è¦åŒ–
        function normalizeText(text) {
            return text
                .toLowerCase()
                .replace(/[ï¼ï¼Ÿã€‚ã€ãƒ»ã€Œã€ã€ã€ã€ã€‘ï¼ˆï¼‰\(\)\[\]\-\:ï¼š]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
        }

        // æ—¥æœ¬èªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºï¼ˆé‡è¦ãªå˜èªã‚’æŠ½å‡ºï¼‰
        function extractKeywords(text) {
            const keywords = new Set();

            // é‡è¦ãªçœ‹è­·ãƒ»åŒ»ç™‚é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡º
            const importantPatterns = [
                /çœ‹è­·å¸«/g, /è»¢è·/g, /å¹´å/g, /çµ¦æ–™/g, /çµ¦ä¸/g, /é€€è·/g, /è¾ã‚/g,
                /å¤œå‹¤/g, /ã‚¯ãƒªãƒ‹ãƒƒã‚¯/g, /ç—…é™¢/g, /é¢æ¥/g, /å±¥æ­´æ›¸/g, /å¿—æœ›å‹•æ©Ÿ/g,
                /ã‚­ãƒ£ãƒªã‚¢/g, /è³‡æ ¼/g, /ã‚„ã‚ŠãŒã„/g, /ã‚¹ãƒˆãƒ¬ã‚¹/g, /äººé–“é–¢ä¿‚/g,
                /ãƒ‘ãƒ¯ãƒãƒ©/g, /é›¢è·/g, /ç•°å‹•/g, /æ–°äºº/g, /1å¹´ç›®/g, /40ä»£/g, /20ä»£/g,
                /ç¾å®¹/g, /è¨ªå•/g, /å°å…/g, /ç·©å’Œã‚±ã‚¢/g, /ç²¾ç¥ç§‘/g, /å¤–æ¥/g,
                /å‡†çœ‹è­·å¸«/g, /æ­£çœ‹è­·å¸«/g, /ã¤ã‚‰ã„/g, /ãã¤ã„/g, /å‘ã„ã¦/g,
                /ãƒ¡ãƒªãƒƒãƒˆ/g, /ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ/g, /é¸ã³æ–¹/g, /æ–¹æ³•/g, /ç†ç”±/g
            ];

            for (const pattern of importantPatterns) {
                const matches = text.match(pattern);
                if (matches) {
                    matches.forEach(m => keywords.add(m));
                }
            }

            return keywords;
        }

        // ãƒ†ã‚­ã‚¹ãƒˆé¡ä¼¼åº¦ (N-gram ãƒ™ãƒ¼ã‚¹)
        function textSimilarity(text1, text2) {
            if (text1 === text2) return 1;

            const ngrams1 = getNgrams(text1, 2);
            const ngrams2 = getNgrams(text2, 2);

            if (ngrams1.size === 0 || ngrams2.size === 0) return 0;

            let intersection = 0;
            for (const ngram of ngrams1) {
                if (ngrams2.has(ngram)) intersection++;
            }

            const union = ngrams1.size + ngrams2.size - intersection;
            return intersection / union;
        }

        // N-gramç”Ÿæˆ
        function getNgrams(text, n) {
            const ngrams = new Set();
            for (let i = 0; i <= text.length - n; i++) {
                ngrams.add(text.substring(i, i + n));
            }
            return ngrams;
        }

        // ãƒãƒƒãƒã™ã‚‹è¦‹å‡ºã—ã‚’æ¤œç´¢ï¼ˆã‚ˆã‚Šç·©ã„åŸºæº–ï¼‰
        function findMatchingHeadings(headings1, headings2) {
            const matches = [];

            for (const h1 of headings1) {
                for (const h2 of headings2) {
                    const t1 = normalizeText(h1.text);
                    const t2 = normalizeText(h2.text);

                    // N-gramé¡ä¼¼åº¦
                    const ngramSim = textSimilarity(t1, t2);

                    // å…±é€šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
                    const words1 = new Set(t1.split(/\s+/).filter(w => w.length >= 2));
                    const words2 = new Set(t2.split(/\s+/).filter(w => w.length >= 2));
                    let commonCount = 0;
                    for (const w of words1) {
                        if (words2.has(w)) commonCount++;
                    }
                    const wordSim = words1.size > 0 ? commonCount / Math.max(words1.size, words2.size) : 0;

                    // è¤‡åˆã‚¹ã‚³ã‚¢
                    const combinedSim = Math.max(ngramSim, wordSim * 0.8);

                    if (combinedSim > 0.2) {  // ã—ãã„å€¤ã‚’å¤§å¹…ã«ä¸‹ã’ãŸ
                        matches.push({
                            heading1: h1.text,
                            heading2: h2.text,
                            similarity: Math.round(combinedSim * 100)
                        });
                    }
                }
            }

            return matches.sort((a, b) => b.similarity - a.similarity);
        }

        // çµæœè¡¨ç¤º
        function displayResults() {
            displayCannibalizations();
            displayHeadingsList();
        }

        // ã‚«ãƒ‹ãƒãƒªçµæœè¡¨ç¤º
        function displayCannibalizations() {
            const filterLevel = parseInt(document.getElementById('filter-level')?.value || 40);
            const container = document.getElementById('cannibalization-results');

            const filtered = cannibalizations.filter(c => c.similarity >= filterLevel);

            if (filtered.length === 0) {
                const levelText = filterLevel >= 60 ? 'â—è¦å¯¾ç­–' : filterLevel >= 40 ? 'â—â—‹è¦å¯¾ç­–ãƒ»è¦ç¢ºèª' : 'â—â—‹â–³ã™ã¹ã¦';
                container.innerHTML = `
                    <div class="no-results">
                        <p>ğŸ‰ ${levelText}ãƒ¬ãƒ™ãƒ«ã®ã‚«ãƒ‹ãƒãƒªã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚</p>
                        <p style="margin-top: 8px; font-size: 14px;">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€ã‚ˆã‚Šå¤šãã®ãƒšã‚¢ã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(c => {
                // â—â—‹â–³è¡¨è¨˜ã¨ãƒ©ãƒ™ãƒ«
                let riskLevel, riskLabel, badgeClass, showBadge;
                if (c.similarity >= 60) {
                    riskLevel = 'â—';
                    riskLabel = 'è¦å¯¾ç­–';
                    badgeClass = 'similarity-high';
                    showBadge = true;
                } else if (c.similarity >= 40) {
                    riskLevel = 'â—‹';
                    riskLabel = 'è¦ç¢ºèª';
                    badgeClass = 'similarity-medium';
                    showBadge = true;
                } else {
                    riskLevel = 'â–³';
                    riskLabel = 'é–¢é€£ã‚ã‚Š';
                    badgeClass = 'similarity-low';
                    showBadge = false;  // â–³ã¯å³ä¸Šãƒãƒƒã‚¸éè¡¨ç¤º
                }

                // è§£æ±ºç­–ã®ææ¡ˆ
                let solutionHtml = '';
                if (c.similarity >= 40) {
                    const solutions = getSolutions(c.similarity, c.matchingHeadings);
                    solutionHtml = `
                        <div class="solution-box">
                            <h4>ğŸ’¡ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h4>
                            <ul>
                                ${solutions.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                return `
                    <div class="cannibalization-item">
                        <div class="cannibalization-header">
                            <span>${riskLevel} ${riskLabel}</span>
                            ${showBadge ? `<span class="similarity-badge ${badgeClass}">${riskLabel}</span>` : ''}
                        </div>
                        <div class="article-pair">
                            <div class="article-box">
                                <h4>è¨˜äº‹1</h4>
                                <a href="${c.article1.url}" target="_blank">${escapeHtml(c.article1.title)}</a>
                                <ul class="headings-list">
                                    ${c.article1.headings.slice(0, 5).map(h =>
                                        `<li><strong>${h.level.toUpperCase()}:</strong> ${escapeHtml(h.text)}</li>`
                                    ).join('')}
                                    ${c.article1.headings.length > 5 ? `<li>... ä»– ${c.article1.headings.length - 5} ä»¶</li>` : ''}
                                </ul>
                            </div>
                            <div class="article-box">
                                <h4>è¨˜äº‹2</h4>
                                <a href="${c.article2.url}" target="_blank">${escapeHtml(c.article2.title)}</a>
                                <ul class="headings-list">
                                    ${c.article2.headings.slice(0, 5).map(h =>
                                        `<li><strong>${h.level.toUpperCase()}:</strong> ${escapeHtml(h.text)}</li>`
                                    ).join('')}
                                    ${c.article2.headings.length > 5 ? `<li>... ä»– ${c.article2.headings.length - 5} ä»¶</li>` : ''}
                                </ul>
                            </div>
                        </div>
                        ${c.matchingHeadings.length > 0 ? `
                            <div class="matching-headings">
                                <h4>é¡ä¼¼ã—ã¦ã„ã‚‹è¦‹å‡ºã—</h4>
                                <ul>
                                    ${c.matchingHeadings.slice(0, 5).map(m =>
                                        `<li>ã€Œ${escapeHtml(m.heading1)}ã€ â‡” ã€Œ${escapeHtml(m.heading2)}ã€</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${solutionHtml}
                    </div>
                `;
            }).join('');
        }

        // è¦‹å‡ºã—ä¸€è¦§è¡¨ç¤º
        function displayHeadingsList() {
            const container = document.getElementById('headings-list');

            container.innerHTML = `
                <table class="headings-table">
                    <thead>
                        <tr>
                            <th style="width: 30%;">URL</th>
                            <th style="width: 20%;">ã‚¿ã‚¤ãƒˆãƒ«</th>
                            <th style="width: 50%;">è¦‹å‡ºã—</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${articlesData.map(article => `
                            <tr>
                                <td><a href="${article.url}" target="_blank">${escapeHtml(article.url)}</a></td>
                                <td>${escapeHtml(article.title)}</td>
                                <td>
                                    ${article.error ?
                                        `<span style="color: #d32f2f;">ã‚¨ãƒ©ãƒ¼: ${escapeHtml(article.error)}</span>` :
                                        article.headings.map(h =>
                                            `<span style="display: block; margin: 2px 0; font-size: 13px;">
                                                <strong>${h.level.toUpperCase()}:</strong> ${escapeHtml(h.text)}
                                            </span>`
                                        ).join('')
                                    }
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // CSVå‡ºåŠ›
        function exportResults() {
            const filterLevel = parseInt(document.getElementById('filter-level')?.value || 40);
            const filtered = cannibalizations.filter(c => c.similarity >= filterLevel);

            let csv = 'URL1,ã‚¿ã‚¤ãƒˆãƒ«1,URL2,ã‚¿ã‚¤ãƒˆãƒ«2,ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«,é¡ä¼¼è¦‹å‡ºã—\n';

            filtered.forEach(c => {
                const matchingTexts = c.matchingHeadings.map(m =>
                    `${m.heading1} â‡” ${m.heading2}`
                ).join(' | ');

                const riskLabel = c.similarity >= 60 ? 'â—è¦å¯¾ç­–' : c.similarity >= 40 ? 'â—‹è¦ç¢ºèª' : 'â–³é–¢é€£ã‚ã‚Š';
                csv += `"${c.article1.url}","${c.article1.title}","${c.article2.url}","${c.article2.title}","${riskLabel}","${matchingTexts}"\n`;
            });

            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `cannibalization_report_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // è¦‹å‡ºã—ãƒªã‚¹ãƒˆCSVå‡ºåŠ›ï¼ˆ1è¨˜äº‹1è¡Œï¼‰
        function exportHeadingsList() {
            let csv = 'URL,ã‚¿ã‚¤ãƒˆãƒ«,è¦‹å‡ºã—\n';

            articlesData.forEach(article => {
                const url = article.url;
                const title = article.title.replace(/"/g, '""');

                if (article.error) {
                    csv += `"${url}","${title}","ã‚¨ãƒ©ãƒ¼: ${article.error}"\n`;
                } else if (article.headings.length === 0) {
                    csv += `"${url}","${title}","è¦‹å‡ºã—ãªã—"\n`;
                } else {
                    // è¦‹å‡ºã—ã‚’ã€Œ<H2>è¦‹å‡ºã—1 <H3>è¦‹å‡ºã—2...ã€ã®å½¢å¼ã§ã¾ã¨ã‚ã‚‹
                    const headingsText = article.headings.map(h =>
                        `<${h.level.toUpperCase()}>${h.text}`
                    ).join(' ').replace(/"/g, '""');
                    csv += `"${url}","${title}","${headingsText}"\n`;
                }
            });

            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `headings_list_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // è§£æ±ºç­–ã‚’ææ¡ˆ
        function getSolutions(similarity, matchingHeadings) {
            const solutions = [];

            if (similarity >= 60) {
                // â— è¦å¯¾ç­–
                solutions.push('è¨˜äº‹ã®çµ±åˆã‚’æ¤œè¨ï¼ˆã©ã¡ã‚‰ã‹ã«å†…å®¹ã‚’ã¾ã¨ã‚ã¦ã€ã‚‚ã†ç‰‡æ–¹ã¯301ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰');
                solutions.push('ç‰‡æ–¹ã®è¨˜äº‹ã®åˆ‡ã‚Šå£ã‚’å¤§ããå¤‰ãˆã‚‹ï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆèª­è€…ã‚„ç›®çš„ã‚’æ˜ç¢ºã«å·®åˆ¥åŒ–ï¼‰');
                solutions.push('canonical ã‚¿ã‚°ã§æ­£è¦URLã‚’æŒ‡å®š');
            } else if (similarity >= 40) {
                // â—‹ è¦ç¢ºèª
                solutions.push('å„è¨˜äº‹ã®æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆç‹™ã†ã‚¯ã‚¨ãƒªï¼‰ã‚’æ˜ç¢ºã«åˆ†ã‘ã‚‹');
                solutions.push('é¡ä¼¼è¦‹å‡ºã—ã®è¡¨ç¾ã‚„å†…å®¹ã‚’å·®åˆ¥åŒ–ã™ã‚‹');
                solutions.push('å†…éƒ¨ãƒªãƒ³ã‚¯ã§ç›¸äº’ã«é–¢é€£ä»˜ã‘ã€å½¹å‰²ã®é•ã„ã‚’æ˜ç¢ºã«ã™ã‚‹');
            }

            return solutions;
        }
    </script>
</body>
</html>
